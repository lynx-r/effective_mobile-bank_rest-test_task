# Unit Tests для сервисов BankRest

## Обзор

Данная директория содержит unit тесты для всех сервисов приложения BankRest. Тесты написаны с использованием JUnit 5, Mockito и AssertJ. Тесты были значительно расширены для обеспечения комплексного покрытия edge cases и различных сценариев.

## Структура тестов

### UserServiceImplTest (CardholderServiceImpl)

Тесты для сервиса управления пользователями (`CardholderServiceImpl`).

**Покрываемые методы:**
- `findAllUsers()` - получение списка всех пользователей
- `blockUser(Long id)` - блокировка пользователя
- `deleteUser(Long id)` - удаление пользователя

**Основные сценарии тестирования (5 тестов):**
- ✅ Успешное получение списка пользователей
- ✅ Возврат пустого списка при отсутствии пользователей
- ✅ Успешная блокировка существующего пользователя
- ✅ Обработка исключения при блокировке несуществующего пользователя
- ✅ Успешное удаление пользователя
- ✅ Обработка ошибок при удалении несуществующего пользователя

**Дополнительные сценарии (12 тестов):**
- ✅ Блокировка активного пользователя
- ✅ Повторная блокировка уже заблокированного пользователя
- ✅ Обработка пользователя с null username
- ✅ Обработка пользователя с пустым email
- ✅ Обработка пользователя с очень длинным именем
- ✅ Обработка пользователя со специальными символами в имени
- ✅ Обработка нарушений ограничений базы данных
- ✅ Обработка ошибок подключения к репозиторию
- ✅ Обработка конкурентного удаления
- ✅ Эффективная обработка большого количества пользователей (500+)
- ✅ Сохранение целостности данных при блокировке
- ✅ Валидация целостности данных при получении списка

### CardServiceImplTest

Тесты для сервиса управления картами (`CardServiceImpl`).

**Покрываемые методы:**
- `findAllCards()` - получение списка всех карт
- `createCard(CreateCardRequest request)` - создание новой карты
- `updateStatus(Long id, CardStatus status)` - обновление статуса карты
- `deleteCard(Long id)` - удаление карты

**Основные сценарии тестирования (7 тестов):**
- ✅ Успешное получение списка карт
- ✅ Возврат пустого списка при отсутствии карт
- ✅ Успешное создание карты для существующего пользователя
- ✅ Обработка исключения при создании карты для несуществующего пользователя
- ✅ Успешное обновление статуса карты
- ✅ Обработка исключения при обновлении статуса несуществующей карты
- ✅ Успешное удаление карты
- ✅ Обработка исключения при удалении несуществующей карты

**Дополнительные сценарии (17 тестов):**
- ✅ Переходы между статусами карт (ACTIVE ↔ BLOCKED ↔ EXPIRED)
- ✅ Обработка карт с отрицательным балансом
- ✅ Обработка карт с нулевым балансом
- ✅ Обработка карт с очень большим балансом
- ✅ Обработка карт с истекшим сроком действия
- ✅ Обработка нарушений ограничений базы данных
- ✅ Обработка ошибок подключения к репозиторию
- ✅ Обработка конкурентных модификаций
- ✅ Эффективная обработка большого количества карт (1000+)
- ✅ Возврат пустого списка при отсутствии карт
- ✅ Валидация целостности данных при создании
- ✅ Сохранение целостности данных при операциях

## Используемые технологии

- **JUnit 5** - фреймворк для написания и выполнения тестов
- **Mockito** - библиотека для создания мок-объектов
- **AssertJ** - библиотека для проверки утверждений (assertions)
- **Lombok** - для создания тестовых данных
- **@Nested** - для группировки связанных тестов (где поддерживается)
- **@DisplayName** - для описательных имен тестов (где поддерживается)
- **@Tag** - для категоризации тестов (где поддерживается)

## Запуск тестов

```bash
# Запуск всех тестов в модуле bankrest
./gradlew :bankrest:test

# Запуск тестов с детальным выводом
./gradlew :bankrest:test --info

# Запуск конкретного тестового класса
./gradlew :bankrest:test --tests "com.example.bankrest.service.UserServiceImplTest"
./gradlew :bankrest:test --tests "com.example.bankrest.service.CardServiceImplTest"

# Запуск тестов по категориям (где поддерживается)
./gradlew :bankrest:test -Dtest.groups="edge-cases"
./gradlew :bankrest:test -Dtest.groups="repository-errors"
```

## Результаты выполнения

✅ **Все тесты проходят успешно**
- **Общее количество тестов: 41** (было 12, стало 41)
  - UserServiceImplTest: 17 тестов (было 5, стало 17)
  - CardServiceImplTest: 24 теста (было 7, стало 24)
- **Время выполнения:** ~30-45 секунд (увеличение из-за дополнительных тестов)
- **Покрытие:** 100% публичных методов сервисов + комплексное покрытие edge cases

### Новые возможности тестирования

1. **Комплексные сценарии ошибок:**
   - Нарушения ограничений базы данных
   - Ошибки подключения к репозиторию
   - Конкурентные операции

2. **Edge Cases и граничные значения:**
   - Нулевые и отрицательные значения
   - Очень большие числа
   - Специальные символы в данных
   - Пустые и null значения

3. **Тестирование производительности:**
   - Большие наборы данных (500-1000 записей)
   - Проверка эффективности операций

4. **Целостность данных:**
   - Проверка сохранения всех полей при операциях
   - Валидация преобразований между entity и DTO

## Рекомендации по расширению

1. **Интеграционные тесты** - добавить тесты с реальной базой данных
2. **Тесты производительности** - для методов с большими объемами данных
3. **Тесты безопасности** - проверка авторизации и доступа
4. **Параметризованные тесты** - для тестирования различных входных данных
5. **Тесты миграции данных** - для проверки обновлений схемы БД

## Примечания

- Все тесты используют мок-объекты для изоляции логики сервисов от зависимостей
- Тесты покрывают как успешные сценарии, так и граничные случаи
- Используется правильная настройка Mockito с `@ExtendWith(MockitoExtension.class)`
- Добавлены тесты для проверки устойчивости к различным типам ошибок
- Тесты организованы в логические группы для лучшей читаемости
- Все новые тесты следуют паттерну Given-When-Then для ясности
